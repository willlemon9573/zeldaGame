using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using SprintZero1.Entities.EnemyEntities;
using System.Collections.Generic;

namespace SprintZero1.StatePatterns.BossStatePatterns.AquamentusStatePattern
{
    internal class AquamentusVulnerabilityState : BaseBossState
    {
        private bool _isVulnerable;
        private const float InvulnerabilityTime = 1 / 2f;
        private float _elapsedInvulnerabilityTime;
        private readonly List<Color> _colorList;
        private const float TimeToUpdate = 1 / 9f;
        private float _flashTime;
        private int _colorIndex;
        public AquamentusVulnerabilityState(BaseBossEntity boss) : base(boss)
        {
            _isVulnerable = true;
            _colorList = new List<Color>() { Color.Red, Color.White };
        }

        /// <summary>
        /// Request this when the boss takes damage so they enter their invulnerable state
        /// </summary>
        public override void Request()
        {
            if (_isVulnerable == false || _boss.Health <= 0) { return; }
            _isVulnerable = false;
            _elapsedInvulnerabilityTime = 0f;
            _colorIndex = 0;
        }

        public override void Draw(SpriteBatch spriteBatch)
        {
            if (_isVulnerable || _boss.Health <= 0) { return; }
            _boss.Sprite.Draw(spriteBatch, _boss.Position, _colorList[_colorIndex]);
        }

        public override void Update(GameTime gameTime)
        {
            if (_isVulnerable || _boss.Health <= 0) { return; }
            float deltaTime = (float)gameTime.ElapsedGameTime.TotalSeconds;
            _elapsedInvulnerabilityTime += deltaTime;
            _flashTime += deltaTime;
            if (_flashTime >= TimeToUpdate) // flash every update
            {
                _flashTime -= TimeToUpdate;
                _colorIndex = (_colorIndex + 1) % _colorList.Count;
            }

            if (_elapsedInvulnerabilityTime >= InvulnerabilityTime)
            {
                _isVulnerable = true;
                if (_boss is AquamentusEntity boss)
                {
                    boss.BeenAttacked = false;
                }
            }
        }
    }
}
